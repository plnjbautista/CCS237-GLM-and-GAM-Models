model_data_gamma$NABOVE <- y_gamma
# Fit GLM with Gamma (log link)
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
# Predictions on original data
predictions_gamma <- predict(glm_gamma, newdata = model_data, type = "response")
# Store performance metrics
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = r_squared(y, predictions_gamma),
RMSE = rmse(y, predictions_gamma),
MAE = mae(y, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['gamma']]$AIC,
glm_results[['gamma']]$BIC,
glm_results[['gamma']][['R-squared']]))
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Print summary of all GLM performance metrics ---
cat("\n--- Summary of GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
if (is.numeric(value)) {
cat(sprintf("  %s: %.4f\n", metric_name, value))
} else {
cat(sprintf("  %s: %s\n", metric_name, value))
}
}
}
cat("\nGLM models fitted and performance metrics calculated.\n")
cat("\n--- Fitting GLM with Gamma family (log link) ---\n")
tryCatch({
# Check for non-positive values
if (any(y <= 0)) {
cat(sprintf("Warning: NABOVE contains %d non-positive values. Adding small constant.\n",
sum(y <= 0)))
y_gamma <- y + 0.1  # Add small constant to avoid zeros
} else {
y_gamma <- y
}
# Prepare data
model_data_gamma <- model_data
model_data_gamma$NABOVE <- y_gamma
# Fit GLM with Gamma (log link)
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
# Predictions on the adjusted data (to avoid NaNs)
predictions_gamma <- predict(glm_gamma, newdata = model_data_gamma, type = "response")
# Store performance metrics
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = r_squared(y_gamma, predictions_gamma),
RMSE = rmse(y_gamma, predictions_gamma),
MAE = mae(y_gamma, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['gamma']]$AIC,
glm_results[['gamma']]$BIC,
glm_results[['gamma']][['R-squared']]))
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Print summary of all GLM performance metrics ---
cat("\n--- Summary of GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
if (is.numeric(value)) {
cat(sprintf("  %s: %.4f\n", metric_name, value))
} else {
cat(sprintf("  %s: %s\n", metric_name, value))
}
}
}
cat("\nGLM models fitted and performance metrics calculated.\n")
cat("\n--- Fitting GLM with Gamma family (log link) ---\n")
tryCatch({
# Check for non-positive values
if (any(y <= 0)) {
cat(sprintf("Warning: NABOVE contains %d non-positive values. Adding small constant.\n",
sum(y <= 0)))
y_gamma <- y + 0.1  # Add small constant to avoid zeros
} else {
y_gamma <- y
}
# Prepare data
model_data_gamma <- model_data
model_data_gamma$NABOVE <- y_gamma
# Fit GLM with Gamma (log link)
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
# Predictions on the adjusted data (to avoid NaNs)
predictions_gamma <- predict(glm_gamma, newdata = model_data_gamma, type = "response")
# Store performance metrics
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = r_squared(y_gamma, predictions_gamma),
RMSE = rmse(y_gamma, predictions_gamma),
MAE = mae(y_gamma, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['gamma']]$AIC,
glm_results[['gamma']]$BIC,
glm_results[['gamma']][['R-squared']]))
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Print summary of all GLM performance metrics ---
cat("\n--- Summary of GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
if (is.numeric(value)) {
cat(sprintf("  %s: %.4f\n", metric_name, value))
} else {
cat(sprintf("  %s: %s\n", metric_name, value))
}
}
}
cat("\nGLM models fitted and performance metrics calculated.\n")
# --- Fit Gamma GLM ---
cat("\n--- Fitting GLM with Gamma family (log link) ---\n")
tryCatch({
if (any(y <= 0)) {
cat(sprintf("Warning: NABOVE contains %d non-positive values. Adding small constant.\n",
sum(y <= 0)))
y_gamma <- y + 0.1
} else {
y_gamma <- y
}
model_data_gamma <- model_data
model_data_gamma$NABOVE <- y_gamma
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
predictions_gamma <- predict(glm_gamma, newdata = model_data_gamma, type = "response")
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = r_squared(y_gamma, predictions_gamma),
RMSE = rmse(y_gamma, predictions_gamma),
MAE = mae(y_gamma, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['gamma']]$AIC,
glm_results[['gamma']]$BIC,
glm_results[['gamma']][['R-squared']]))
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Unified Summary of All GLMs ---
cat("\n--- Summary of All GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
if (is.numeric(value)) {
cat(sprintf("  %s: %.4f\n", metric_name, value))
} else {
cat(sprintf("  %s: %s\n", metric_name, value))
}
}
}
cat("\nAll GLM models fitted and performance metrics calculated.\n")
# Storage for models and results
glm_models <- list()
glm_results <- list()
# --- GLM Gaussian (Linear) ---
cat("\n--- Fitting GLM with Gaussian family (linear) ---\n")
tryCatch({
glm_linear <- glm(glm_formula, data = model_data, family = gaussian())
glm_models[['linear']] <- glm_linear
predictions_linear <- predict(glm_linear, type = "response")
glm_results[['linear']] <- list(
AIC = AIC(glm_linear),
BIC = BIC(glm_linear),
'R-squared' = r_squared(y, predictions_linear),
RMSE = rmse(y, predictions_linear),
MAE = mae(y, predictions_linear)
)
cat("Linear GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['linear']]$AIC,
glm_results[['linear']]$BIC,
glm_results[['linear']]$'R-squared'))
}, error = function(e) {
cat(sprintf("Error fitting Linear GLM: %s\n", e$message))
glm_results[['linear']] <- list(Error = e$message)
})
# --- GLM Poisson (Log) ---
cat("\n--- Fitting GLM with Poisson family (log link) ---\n")
tryCatch({
glm_poisson <- glm(glm_formula, data = model_data, family = poisson(link = "log"))
glm_models[['log']] <- glm_poisson
predictions_poisson <- predict(glm_poisson, type = "response")
glm_results[['log']] <- list(
AIC = AIC(glm_poisson),
BIC = BIC(glm_poisson),
'R-squared' = r_squared(y, predictions_poisson),
RMSE = rmse(y, predictions_poisson),
MAE = mae(y, predictions_poisson)
)
cat("Poisson GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['log']]$AIC,
glm_results[['log']]$BIC,
glm_results[['log']]$'R-squared'))
}, error = function(e) {
cat(sprintf("Error fitting Poisson GLM: %s\n", e$message))
glm_results[['log']] <- list(Error = e$message)
})
# --- Fit Gamma GLM ---
cat("\n--- Fitting GLM with Gamma family (log link) ---\n")
tryCatch({
if (any(y <= 0)) {
cat(sprintf("Warning: NABOVE contains %d non-positive values. Adding small constant.\n",
sum(y <= 0)))
y_gamma <- y + 0.1
} else {
y_gamma <- y
}
model_data_gamma <- model_data
model_data_gamma$NABOVE <- y_gamma
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
predictions_gamma <- predict(glm_gamma, newdata = model_data_gamma, type = "response")
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = r_squared(y_gamma, predictions_gamma),
RMSE = rmse(y_gamma, predictions_gamma),
MAE = mae(y_gamma, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['gamma']]$AIC,
glm_results[['gamma']]$BIC,
glm_results[['gamma']][['R-squared']]))
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Unified Summary of All GLMs ---
cat("\n--- Summary of All GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
if (is.numeric(value)) {
cat(sprintf("  %s: %.4f\n", metric_name, value))
} else {
cat(sprintf("  %s: %s\n", metric_name, value))
}
}
}
cat("\nAll GLM models fitted and performance metrics calculated.\n")
View(glm_results)
cat("DEBUG: models currently in glm_results:\n")
print(names(glm_results))
# ==============================================================================
cat("\n### Fitting GLM Models\n")
# --- Helper functions for metrics ---
r_squared <- function(y, yhat) {
if (all(is.na(yhat)) || length(y) != length(yhat)) return(NA)
1 - sum((y - yhat)^2) / sum((y - mean(y))^2)
}
rmse <- function(y, yhat) {
if (all(is.na(yhat)) || length(y) != length(yhat)) return(NA)
sqrt(mean((y - yhat)^2))
}
mae <- function(y, yhat) {
if (all(is.na(yhat)) || length(y) != length(yhat)) return(NA)
mean(abs(y - yhat))
}
# Safe wrapper to handle errors
safe_metric <- function(metric_fun, y, yhat) {
tryCatch(metric_fun(y, yhat), error = function(e) NA)
}
# --- Create formula ---
glm_formula <- as.formula(paste("NABOVE ~", paste(names(X), collapse = " + ")))
cat(sprintf("\nGLM Formula: %s\n", deparse(glm_formula)))
# --- Storage for models and results ---
glm_models <- list()
glm_results <- list()
# --- 1. GLM Gaussian (Linear) ---
cat("\n--- Fitting GLM with Gaussian family (linear) ---\n")
tryCatch({
glm_linear <- glm(glm_formula, data = model_data, family = gaussian())
glm_models[['linear']] <- glm_linear
predictions_linear <- predict(glm_linear, type = "response")
glm_results[['linear']] <- list(
AIC = AIC(glm_linear),
BIC = BIC(glm_linear),
'R-squared' = safe_metric(r_squared, y, predictions_linear),
RMSE = safe_metric(rmse, y, predictions_linear),
MAE = safe_metric(mae, y, predictions_linear)
)
cat("Linear GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['linear']]$AIC,
glm_results[['linear']]$BIC,
glm_results[['linear']][['R-squared']]))
}, error = function(e) {
cat(sprintf("Error fitting Linear GLM: %s\n", e$message))
glm_results[['linear']] <- list(Error = e$message)
})
# --- 2. GLM Poisson (Log) ---
cat("\n--- Fitting GLM with Poisson family (log link) ---\n")
tryCatch({
glm_poisson <- glm(glm_formula, data = model_data, family = poisson(link = "log"))
glm_models[['log']] <- glm_poisson
predictions_poisson <- predict(glm_poisson, type = "response")
glm_results[['log']] <- list(
AIC = AIC(glm_poisson),
BIC = BIC(glm_poisson),
'R-squared' = safe_metric(r_squared, y, predictions_poisson),
RMSE = safe_metric(rmse, y, predictions_poisson),
MAE = safe_metric(mae, y, predictions_poisson)
)
cat("Poisson GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['log']]$AIC,
glm_results[['log']]$BIC,
glm_results[['log']][['R-squared']]))
}, error = function(e) {
cat(sprintf("Error fitting Poisson GLM: %s\n", e$message))
glm_results[['log']] <- list(Error = e$message)
})
# --- 3. GLM Gamma (log link) ---
cat("\n--- Fitting GLM with Gamma family (log link) ---\n")
tryCatch({
y_gamma <- ifelse(y <= 0, y + 0.1, y)  # add small constant if needed
if (any(y <= 0)) {
cat(sprintf("Warning: NABOVE contained %d non-positive values, adjusted by +0.1\n", sum(y <= 0)))
}
model_data_gamma <- model_data
model_data_gamma$NABOVE <- y_gamma
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
predictions_gamma <- predict(glm_gamma, newdata = model_data_gamma, type = "response")
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = safe_metric(r_squared, y_gamma, predictions_gamma),
RMSE = safe_metric(rmse, y_gamma, predictions_gamma),
MAE = safe_metric(mae, y_gamma, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
cat(sprintf("  AIC: %.4f, BIC: %.4f, R²: %.4f\n",
glm_results[['gamma']]$AIC,
glm_results[['gamma']]$BIC,
glm_results[['gamma']][['R-squared']]))
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Unified Summary of All GLMs ---
cat("\n--- Summary of All GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
if (is.numeric(value)) {
cat(sprintf("  %s: %.4f\n", metric_name, value))
} else {
cat(sprintf("  %s: %s\n", metric_name, value))
}
}
}
cat("\nAll GLM models fitted and performance metrics calculated.\n")
# 10. FIT GLM MODELS
cat("\n### Fitting GLM Models ###\n")
# --- Helper functions for metrics ---
r_squared <- function(y, yhat) {
if (all(is.na(yhat)) || length(y) != length(yhat)) return(NA)
1 - sum((y - yhat)^2) / sum((y - mean(y))^2)
}
rmse <- function(y, yhat) {
if (all(is.na(yhat)) || length(y) != length(yhat)) return(NA)
sqrt(mean((y - yhat)^2))
}
mae <- function(y, yhat) {
if (all(is.na(yhat)) || length(y) != length(yhat)) return(NA)
mean(abs(y - yhat))
}
# Safe wrapper to catch errors in metric calculations
safe_metric <- function(metric_fun, y, yhat) {
tryCatch(metric_fun(y, yhat), error = function(e) NA)
}
# --- Create GLM formula ---
glm_formula <- as.formula(paste("NABOVE ~", paste(names(X), collapse = " + ")))
cat(sprintf("\nGLM Formula: %s\n", deparse(glm_formula)))
# --- Storage for models and results ---
glm_models <- list()
glm_results <- list()
# --- 1. GLM Gaussian (Linear) ---
cat("\n--- Fitting GLM with Gaussian family (linear) ---\n")
tryCatch({
glm_linear <- glm(glm_formula, data = model_data, family = gaussian())
glm_models[['linear']] <- glm_linear
predictions_linear <- predict(glm_linear, type = "response")
glm_results[['linear']] <- list(
AIC = AIC(glm_linear),
BIC = BIC(glm_linear),
'R-squared' = safe_metric(r_squared, y, predictions_linear),
RMSE = safe_metric(rmse, y, predictions_linear),
MAE = safe_metric(mae, y, predictions_linear)
)
cat("Linear GLM fitted successfully.\n")
}, error = function(e) {
cat(sprintf("Error fitting Linear GLM: %s\n", e$message))
glm_results[['linear']] <- list(Error = e$message)
})
# --- 2. GLM Poisson (Log link) ---
cat("\n--- Fitting GLM with Poisson family (log link) ---\n")
tryCatch({
glm_poisson <- glm(glm_formula, data = model_data, family = poisson(link = "log"))
glm_models[['log']] <- glm_poisson
predictions_poisson <- predict(glm_poisson, type = "response")
glm_results[['log']] <- list(
AIC = AIC(glm_poisson),
BIC = BIC(glm_poisson),
'R-squared' = safe_metric(r_squared, y, predictions_poisson),
RMSE = safe_metric(rmse, y, predictions_poisson),
MAE = safe_metric(mae, y, predictions_poisson)
)
cat("Poisson GLM fitted successfully.\n")
}, error = function(e) {
cat(sprintf("Error fitting Poisson GLM: %s\n", e$message))
glm_results[['log']] <- list(Error = e$message)
})
# --- 3. GLM Gamma (log link) ---
cat("\n--- Fitting GLM with Gamma family (log link) ---\n")
tryCatch({
# Adjust non-positive values if present
y_gamma <- ifelse(y <= 0, y + 0.1, y)
if (any(y <= 0)) {
cat(sprintf("Warning: NABOVE contained %d non-positive values, adjusted by +0.1\n", sum(y <= 0)))
}
model_data_gamma <- model_data
model_data_gamma$NABOVE <- y_gamma
glm_gamma <- glm(glm_formula, data = model_data_gamma, family = Gamma(link = "log"))
glm_models[['gamma']] <- glm_gamma
predictions_gamma <- predict(glm_gamma, newdata = model_data_gamma, type = "response")
glm_results[['gamma']] <- list(
AIC = AIC(glm_gamma),
BIC = BIC(glm_gamma),
'R-squared' = safe_metric(r_squared, y_gamma, predictions_gamma),
RMSE = safe_metric(rmse, y_gamma, predictions_gamma),
MAE = safe_metric(mae, y_gamma, predictions_gamma)
)
cat("Gamma GLM fitted successfully.\n")
}, warning = function(w) {
cat(sprintf("Warning: %s\n", w$message))
}, error = function(e) {
cat(sprintf("Error fitting Gamma GLM: %s\n", e$message))
glm_results[['gamma']] <- list(Error = e$message)
})
# --- Unified Summary of All GLMs ---
cat("\n--- Summary of All GLM Model Performance ---\n")
for (model_name in names(glm_results)) {
cat(sprintf("\n%s GLM:\n", toupper(model_name)))
for (metric_name in names(glm_results[[model_name]])) {
value <- glm_results[[model_name]][[metric_name]]
cat(sprintf("  %s: %s\n", metric_name, ifelse(is.na(value), "NA", sprintf("%.4f", value))))
}
}
cat("\nAll GLM models fitted and performance metrics calculated.\n")
View(glm_models)
# ==============================================================================
# GLM vs GAM Analysis - STAR98 Dataset (R Implementation)
# Author: Pauline Joy O. Bautista
# ==============================================================================
# Install all packages at once
install.packages(c("tidyverse", "car", "mgcv", "ggplot2", "gridExtra", "knitr"),
dependencies = TRUE)
# Load libraries
library(tidyverse)
library(car)
library(mgcv)
library(ggplot2)
library(gridExtra)
library(knitr)
install.packages(c("tidyverse", "car", "mgcv", "ggplot2", "gridExtra", "knitr"), dependencies = TRUE)
